<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>realfimodel — 50-Unit REI Model</title>
<meta name="description" content="Free real estate multifamily finance model — value an apartment before you buy, finance, or make an offer." />
<meta name="keywords" content="free real estate multifamily finance model, apartment valuation, pro forma, IRR, cash-on-cash" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#ffffff;--accent:#0ea5a4;--muted:#475569;--yellow:#fff8dc;--formula:#f3f6fb;--drop:#fde68a}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:#0f172a}
  .wrap{max-width:1100px;margin:10px auto;padding:10px}
  header{display:flex;align-items:center;gap:12px}
  #logo{height:48px;width:48px;object-fit:contain}
  h1{font-size:18px;margin:0}
  .meta{font-size:12px;color:var(--muted)}
  .controls{margin-left:auto;display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(90deg,#06b6d4,#3b82f6);color:white}

  .layout{display:grid;grid-template-columns:420px 1fr;gap:12px;margin-top:12px}
  .panel{border-radius:8px;padding:10px;border:1px solid #e6eef8;background:#fff}
  .compact-row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;font-size:13px}
  label{font-size:12px;color:var(--muted);margin-right:8px}
  input[type=number], input[type=text], select{padding:6px;border-radius:6px;border:1px solid #e6eef8;width:120px}
  input.input-yellow{background:var(--yellow)}
  input.readonly{background:var(--formula);border:1px dashed #dbeafe}
  .units-table{width:100%;border-collapse:collapse;margin-top:6px}
  .units-table th,.units-table td{padding:6px;border-bottom:1px solid #f3f6fb;font-size:12px}
  .units-table td input{width:80px}
  .units-table td.input{background:var(--yellow)}

  table.pro{border-collapse:collapse;width:100%;min-width:900px;margin-top:8px}
  table.pro th, table.pro td{padding:6px;border:1px solid #eef4fb;font-size:12px;text-align:right}
  table.pro th{background:#fbfdff;color:var(--muted);text-align:left}

  .kpis{display:flex;gap:8px;margin-top:10px}
  .kpi{flex:1;padding:10px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfdff);text-align:center}

  .media-grid{display:grid;grid-template-columns:1fr 480px 1fr;gap:12px;margin-top:12px}
  .video-drop{border:3px dashed var(--drop);border-radius:8px;min-height:200px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(253,230,138,0.15),rgba(255,255,255,0.02));color:#92400e}
  .video-drop .hint{font-weight:700}

  footer{margin-top:14px;padding-top:8px;border-top:1px solid #eef4fb;text-align:center;font-size:12px;color:var(--muted)}
  footer a{color:var(--accent);margin:0 6px}

  @media print{
    .controls,.btn{display:none}
    .layout{grid-template-columns:1fr 1fr}
    .media-grid{grid-template-columns:1fr}
    .video-drop{border-style:solid}
    table.pro{font-size:10px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img id="logo" src="logo.png" alt="logo">
    <div>
      <h1>realfimodel</h1>
      <div class="meta">Free real estate multifamily finance model — value an apartment before you buy, finance, or make an offer.</div>
    </div>
    <div class="controls">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn primary" id="calcInBtn">Calculate In → Populate Pro Forma</button>
      <button class="btn primary" id="recalcBtn">Recalculate</button>
      <button class="btn" id="exportBtn">Export CSV</button>
    </div>
  </header>

  <div class="layout">
    <!-- Left: Inputs + Operating Expenses (YR1) -->
    <div class="panel">
      <h3 style="margin:0 0 6px">TAB 1 — INPUTS (Edit yellow fields)</h3>
      <div class="meta">Only edit yellow fields. Formula fields are grey and auto-calculated.</div>

      <div style="margin-top:8px">
        <h4 style="margin:6px 0">A. Property & Acquisition</h4>
        <div class="compact-row"><label>Project Name</label><input id="projectName" type="text" class="input-yellow" value="1045 Ocean"></div>
        <div class="compact-row"><label>Total Units</label><input id="totalUnits" type="number" class="input-yellow" value="50"></div>
        <div class="compact-row"><label>Rentable Sq Ft</label><input id="rentableSqft" type="number" class="input-yellow" value="51745"></div>
        <div class="compact-row"><label>Purchase Price</label><input id="purchasePrice" type="number" class="input-yellow" value="20000000"></div>
        <div class="compact-row"><label>Closing Costs %</label><input id="closingPct" type="number" class="input-yellow" value="1"></div>
        <div class="compact-row"><label>Renovation Budget</label><input id="renovation" type="number" class="input-yellow" value="500000"></div>
        <div class="compact-row"><label>Total Initial Basis</label><input id="totalBasis" class="readonly" readonly value="0"></div>

        <h4 style="margin:10px 0 6px">B. Financing (Debt)</h4>
        <div class="compact-row"><label>LTV %</label><input id="ltv" type="number" class="input-yellow" value="60"></div>
        <div class="compact-row"><label>Loan Amount</label><input id="loanAmount" class="readonly" readonly value="0"></div>
        <div class="compact-row"><label>Interest Rate %</label><input id="interestRate" type="number" class="input-yellow" value="5.5"></div>
        <div class="compact-row"><label>Amortization (yrs)</label><input id="amortYears" type="number" class="input-yellow" value="30"></div>
        <div class="compact-row"><label>Loan Term (yrs)</label><input id="loanTerm" type="number" class="input-yellow" value="10"></div>

        <h4 style="margin:10px 0 6px">D. Other Income & Growth</h4>
        <div class="compact-row"><label>Other Income (monthly)</label><input id="otherIncome" type="number" class="input-yellow" value="10500"></div>
        <div class="compact-row"><label>Vacancy %</label><input id="vacancy" type="number" class="input-yellow" value="5"></div>
        <div class="compact-row"><label>Rent Growth %</label><input id="rentGrowth" type="number" class="input-yellow" value="5"></div>
        <div class="compact-row"><label>Expense Growth %</label><input id="expenseGrowth" type="number" class="input-yellow" value="3"></div>

        <h4 style="margin:10px 0 6px">E. Operating Expenses (Year 1) — Inputs</h4>
        <div class="compact-row"><label>Property Taxes %</label><input id="propTaxPct" type="number" class="input-yellow" value="1.25"></div>
        <div class="compact-row"><label>Insurance $/unit/yr</label><input id="insPerUnit" type="number" class="input-yellow" value="500"></div>
        <div class="compact-row"><label>Mgmt Fee % of EGI</label><input id="mgmtPct" type="number" class="input-yellow" value="4"></div>
        <div class="compact-row"><label>Repairs $/unit/yr</label><input id="repairsPerUnit" type="number" class="input-yellow" value="750"></div>
        <div class="compact-row"><label>Utilities $/unit/yr</label><input id="utilPerUnit" type="number" class="input-yellow" value="600"></div>
        <div class="compact-row"><label>Turn/Leasing $/unit/yr</label><input id="turnPerUnit" type="number" class="input-yellow" value="200"></div>
        <div class="compact-row"><label>Asset Mgmt % of EGI</label><input id="assetPct" type="number" class="input-yellow" value="1"></div>

        <h4 style="margin:10px 0 6px">F. Tax Assumptions</h4>
        <div class="compact-row"><label>Improvement %</label><input id="improvePct" type="number" class="input-yellow" value="75"></div>
        <div class="compact-row"><label>Depreciation Life</label><input id="deprLife" type="number" class="input-yellow" value="27.5"></div>
        <div class="compact-row"><label>Investor Tax Rate %</label><input id="taxRate" type="number" class="input-yellow" value="35"></div>

        <h4 style="margin:10px 0 6px">Calculated Formulas (Year 1)</h4>
        <div class="compact-row"><label>Property Taxes (Yr1)</label><input id="propTaxYr1" class="readonly" readonly value="0"></div>
        <div class="compact-row"><label>Insurance (Yr1)</label><input id="insYr1" class="readonly" readonly value="0"></div>
        <div class="compact-row"><label>Repairs (Yr1)</label><input id="repYr1" class="readonly" readonly value="0"></div>
        <div class="compact-row"><label>Utilities (Yr1)</label><input id="utilYr1" class="readonly" readonly value="0"></div>
        <div class="compact-row"><label>Prop Mgmt Fee (Yr1)</label><input id="propMgmtYr1" class="readonly" readonly value="0"></div>
        <div class="compact-row"><label>Asset Mgmt Fee (Yr1)</label><input id="assetMgmtYr1" class="readonly" readonly value="0"></div>
      </div>
    </div>

    <!-- Right: Unit Mix + LTV/Other Income/Improvements -->
    <div class="panel">
      <h3 style="margin:0 0 6px">Unit Mix & Finance</h3>
      <div class="meta">In-place rent and Pro Forma rent retained. Monthly totals are calculated from Pro Forma rent.</div>

      <table class="units-table">
        <thead><tr><th>Unit Type</th><th>Count</th><th>Sq Ft</th><th>In-place Rent</th><th>Pro Forma Rent</th><th>Monthly Total</th></tr></thead>
        <tbody id="unitBody">
          <tr><td>Studio/Loft</td><td class="input"><input class="u-count input-yellow" type="number" value="8"></td><td class="input"><input class="u-sqft input-yellow" type="number" value="600"></td><td class="input"><input class="u-cur input-yellow" type="number" value="1026"></td><td class="input"><input class="u-pro input-yellow" type="number" value="1600"></td><td class="formula right" data-rowindex="0">0</td></tr>
          <tr><td>Studio</td><td class="input"><input class="u-count input-yellow" type="number" value="8"></td><td class="input"><input class="u-sqft input-yellow" type="number" value="650"></td><td class="input"><input class="u-cur input-yellow" type="number" value="2603"></td><td class="input"><input class="u-pro input-yellow" type="number" value="2800"></td><td class="formula right" data-rowindex="1">0</td></tr>
          <tr><td>1BR</td><td class="input"><input class="u-count input-yellow" type="number" value="12"></td><td class="input"><input class="u-sqft input-yellow" type="number" value="750"></td><td class="input"><input class="u-cur input-yellow" type="number" value="3601"></td><td class="input"><input class="u-pro input-yellow" type="number" value="3800"></td><td class="formula right" data-rowindex="2">0</td></tr>
          <tr><td>2BR</td><td class="input"><input class="u-count input-yellow" type="number" value="15"></td><td class="input"><input class="u-sqft input-yellow" type="number" value="900"></td><td class="input"><input class="u-cur input-yellow" type="number" value="4375"></td><td class="input"><input class="u-pro input-yellow" type="number" value="4600"></td><td class="formula right" data-rowindex="3">0</td></tr>
          <tr><td>3BR</td><td class="input"><input class="u-count input-yellow" type="number" value="7"></td><td class="input"><input class="u-sqft input-yellow" type="number" value="1200"></td><td class="input"><input class="u-cur input-yellow" type="number" value="5050"></td><td class="input"><input class="u-pro input-yellow" type="number" value="5300"></td><td class="formula right" data-rowindex="4">0</td></tr>
        </tbody>
        <tfoot>
          <tr><td><strong>TOTALS</strong></td><td id="unitTotal" class="formula">0</td><td id="sqftTotal" class="formula">0</td><td></td><td></td><td id="rentTotal" class="formula">0</td></tr>
        </tfoot>
      </table>

      <hr style="margin:8px 0">
      <div class="compact-row"><label>LTV %</label><input id="ltv2" type="number" class="input-yellow" value="60"></div>
      <div class="compact-row"><label>Interest Rate %</label><input id="interestRate2" type="number" class="input-yellow" value="5.5"></div>
      <div class="compact-row"><label>Other Income (monthly)</label><input id="otherIncome2" type="number" class="input-yellow" value="10500"></div>
      <div class="compact-row"><label>Improvement %</label><input id="improvePct2" type="number" class="input-yellow" value="75"></div>

    </div>

    <!-- Pro Forma (10-year projection) full width -->
    <div style="grid-column:1 / -1">
      <div class="panel">
        <h3 style="margin:0 0 6px">TAB 2 — PRO FORMA (10-Year)</h3>
        <div class="meta">Years 1–10 calculation engine. Use Calculate In to copy in-place rents (or edit Pro Forma rents directly).</div>

        <table class="pro" id="proTable">
          <thead>
            <tr><th>Line Item</th>
              <th>Year 1</th><th>Year 2</th><th>Year 3</th><th>Year 4</th><th>Year 5</th>
              <th>Year 6</th><th>Year 7</th><th>Year 8</th><th>Year 9</th><th>Year 10</th>
            </tr>
          </thead>
          <tbody>
            <tr><th style="text-align:left">Gross Potential Rent</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="gpr${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">(+) Other Income</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="oi${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">(-) Vacancy Loss</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="vac${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">= Effective Gross Income</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="egi${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">Property Taxes</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="tax${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">Insurance</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="ins${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">Management Fee</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="mgmt${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">Repairs & Maint</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="rep${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">Utilities</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="util${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">Asset Mgmt / Other</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="asset${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">= Total Expenses</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="totexp${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">= NOI</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="noi${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">(-) Debt Service</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="debt${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">(-) Capital Reserves</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="capres${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">= Cash Flow After Debt</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="cf${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">TAXABLE INCOME</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="taxable${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">Tax Liability (Savings)</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="taxliab${i+1}">0</td>`).join('') + "</tr>
            <tr><th style="text-align:left">Net Cash Flow (for IRR)</th>" + Array.from({length:10},(_,i)=>`<td class="formula" id="ncf${i+1}">0</td>`).join('') + "</tr>
          </tbody>
        </table>

        <div class="kpis" style="margin-top:10px">
          <div class="kpi"><h3>Purchase Price</h3><p id="k_purchase">—</p></div>
          <div class="kpi"><h3>Initial Equity</h3><p id="k_equity">—</p></div>
          <div class="kpi"><h3>Project IRR</h3><p id="k_irr">—</p></div>
          <div class="kpi"><h3>Equity Multiple</h3><p id="k_em">—</p></div>
          <div class="kpi"><h3>Avg Cash-on-Cash</h3><p id="k_coc">—</p></div>
        </div>

        <div class="media-grid">
          <div></div>
          <div class="video-drop" id="videoDrop"><div class="hint">DROP YOUTUBE VIDEO EMBED HERE</div></div>
          <div></div>
        </div>

      </div>
    </div>

    
  </div>

  <footer>
    <div><a href="https://www.coffeebarconnoisseur.com">coffeebarconnoisseur.com</a> · <a href="https://www.coffeebarroasters.com">coffeebarroasters.com</a> · <a href="https://www.dividond.com">dividond.com</a> · <a href="https://www.decodedmusic.com">decodedmusic.com</a></div>
    <div style="margin-top:6px"><a href="https://www.youtube.com/@designrenovate">YouTube — DesignRenovate</a></div>
  </footer>
</div>

<script>
// Helpers
function toNum(v){return typeof v==='number'?v: (v===''?0:parseFloat(String(v).replace(/[,\$]/g,''))||0)}
function fmt(n){ if(n===null||n===undefined) return '0'; return (Math.round(n)).toLocaleString(); }

// Update monthly totals (calculated from PRO FORMA rent)
function updateUnitTotals(){
  const rows = document.querySelectorAll('#unitBody tr');
  let unitTotal=0; let sqftTotal=0; let rentMonthlyTotal=0;
  rows.forEach((r,idx)=>{
    const count = toNum(r.querySelector('.u-count').value);
    const sqft = toNum(r.querySelector('.u-sqft').value);
    const pro = toNum(r.querySelector('.u-pro').value);
    const monthly = count * pro;
    r.querySelector('td.formula').textContent = fmt(monthly);
    unitTotal += count; sqftTotal += sqft*count; rentMonthlyTotal += monthly;
  });
  document.getElementById('unitTotal').textContent = unitTotal;
  document.getElementById('sqftTotal').textContent = fmt(sqftTotal);
  document.getElementById('rentTotal').textContent = fmt(rentMonthlyTotal);
  return {rentMonthlyTotal,unitTotal,sqftTotal};
}

// PMT and IRR
function pmty(rate, nper, pv){ if(rate<=0) return -(pv)/nper; const r = rate/12; return -(pv*r*Math.pow(1+r,nper))/(Math.pow(1+r,nper)-1); }
function irr(cashflows, guess=0.12){ let x0=guess; for(let i=0;i<200;i++){ let f=0, df=0; for(let t=0;t<cashflows.length;t++){ f += cashflows[t]/Math.pow(1+x0,t); df += -t*cashflows[t]/Math.pow(1+x0,t+1);} const x1 = x0 - f/df; if(!isFinite(x1)) break; if(Math.abs(x1-x0) < 1e-6) return x1; x0=x1;} return NaN; }

// Calculate In: copies In-place rents to Pro Forma rents (if user chooses), then populates pro forma for 10 years
function calculateIn(){
  document.querySelectorAll('#unitBody tr').forEach(r=>{
    const cur = r.querySelector('.u-cur').value;
    if(cur !== undefined && cur !== null && cur !== ''){
      r.querySelector('.u-pro').value = cur;
    }
  });
  recalc(true);
}

function recalc(isCalculateIn){
  const unitInfo = updateUnitTotals();
  const rentMonthlyTotal = unitInfo.rentMonthlyTotal;
  const purchase = toNum(document.getElementById('purchasePrice').value);
  const closingPct = toNum(document.getElementById('closingPct').value)/100;
  const renovation = toNum(document.getElementById('renovation').value);
  const totalBasis = purchase + (purchase*closingPct) + renovation;
  document.getElementById('totalBasis').value = fmt(totalBasis);

  // loan amount formula (primary from left LTV)
  const ltv = toNum(document.getElementById('ltv').value)/100;
  const loan = purchase * ltv;
  document.getElementById('loanAmount').value = fmt(loan);

  // inputs for year math
  const interest = toNum(document.getElementById('interestRate').value)/100;
  const otherMonthly = toNum(document.getElementById('otherIncome').value);
  const vacancy = toNum(document.getElementById('vacancy').value)/100;
  const units = toNum(document.getElementById('totalUnits').value);
  const propTaxPct = toNum(document.getElementById('propTaxPct').value)/100;
  const insPerUnit = toNum(document.getElementById('insPerUnit').value);
  const mgmtPct = toNum(document.getElementById('mgmtPct').value)/100;
  const repairs = toNum(document.getElementById('repairsPerUnit').value);
  const util = toNum(document.getElementById('utilPerUnit').value);
  const assetPct = toNum(document.getElementById('assetPct').value)/100;
  const improvePct = toNum(document.getElementById('improvePct').value)/100;
  const rentGrowth = toNum(document.getElementById('rentGrowth').value)/100;
  const expenseGrowth = toNum(document.getElementById('expenseGrowth').value)/100;
  const amort = toNum(document.getElementById('amortYears').value);

  const years = 10; const gpr = [], oi = [], vac = [], egi = [], totExp = [], noi = [], debt = [], capres = [], cf = [], taxable = [], taxliab = [], ncf = [];

  for(let y=0;y<years;y++){
    const gf = Math.pow(1+rentGrowth,y);
    gpr[y] = rentMonthlyTotal * 12 * gf;
    oi[y] = otherMonthly * 12 * Math.pow(1+rentGrowth,y);
    vac[y] = - (gpr[y] + oi[y]) * vacancy;
    egi[y] = gpr[y] + oi[y] + vac[y];

    const propTax = purchase * propTaxPct * Math.pow(1+expenseGrowth,y);
    const insurance = insPerUnit * units * Math.pow(1+expenseGrowth,y);
    const mgmt = egi[y] * mgmtPct;
    const rep = repairs * units * Math.pow(1+expenseGrowth,y);
    const utilities = util * units * Math.pow(1+expenseGrowth,y);
    const asset = egi[y] * assetPct;
    totExp[y] = propTax + insurance + mgmt + rep + utilities + asset;
    noi[y] = egi[y] - totExp[y];

    if(amort===0) debt[y] = loan * interest; else debt[y] = - pmty(interest, amort*12, loan) * 12;
    capres[y] = - (toNum(document.getElementById('turnPerUnit').value) * units);
    cf[y] = noi[y] - debt[y] + capres[y];

    // tax analysis
    const mortgageInterest = loan * interest; // simplification
    const buildingValue = purchase * improvePct;
    const depreciation = buildingValue / toNum(document.getElementById('deprLife').value);
    taxable[y] = noi[y] - mortgageInterest - depreciation;
    taxliab[y] = taxable[y] * (toNum(document.getElementById('taxRate').value)/100);
    ncf[y] = cf[y];
  }

  // Populate pro forma table and Inputs' Year1 summary fields
  for(let y=1;y<=10;y++){
    document.getElementById('gpr'+y).textContent = fmt(gpr[y-1]);
    document.getElementById('oi'+y).textContent = fmt(oi[y-1]);
    document.getElementById('vac'+y).textContent = fmt(vac[y-1]);
    document.getElementById('egi'+y).textContent = fmt(egi[y-1]);
    document.getElementById('tax'+y).textContent = fmt(Math.round(purchase * propTaxPct * Math.pow(1+expenseGrowth,y-1)));
    document.getElementById('ins'+y).textContent = fmt(Math.round(insPerUnit * units * Math.pow(1+expenseGrowth,y-1)));
    document.getElementById('mgmt'+y).textContent = fmt(Math.round(egi[y-1]*mgmtPct));
    document.getElementById('rep'+y).textContent = fmt(Math.round(repairs * units * Math.pow(1+expenseGrowth,y-1)));
    document.getElementById('util'+y).textContent = fmt(Math.round(util * units * Math.pow(1+expenseGrowth,y-1)));
    document.getElementById('asset'+y).textContent = fmt(Math.round(egi[y-1]*assetPct));
    document.getElementById('totexp'+y).textContent = fmt(Math.round(totExp[y-1]));
    document.getElementById('noi'+y).textContent = fmt(Math.round(noi[y-1]));
    document.getElementById('debt'+y).textContent = fmt(Math.round(-debt[y-1]));
    document.getElementById('capres'+y).textContent = fmt(Math.round(capres[y-1]));
    document.getElementById('cf'+y).textContent = fmt(Math.round(cf[y-1]));
    document.getElementById('taxable'+y).textContent = fmt(Math.round(taxable[y-1]));
    document.getElementById('taxliab'+y).textContent = fmt(Math.round(taxliab[y-1]));
    document.getElementById('ncf'+y).textContent = fmt(Math.round(ncf[y-1]));
  }

  // Fill calculated Year1 totals in Inputs section
  document.getElementById('propTaxYr1').value = fmt(Math.round(purchase * propTaxPct));
  document.getElementById('insYr1').value = fmt(Math.round(insPerUnit * units));
  document.getElementById('repYr1').value = fmt(Math.round(repairs * units));
  document.getElementById('utilYr1').value = fmt(Math.round(util * units));
  document.getElementById('propMgmtYr1').value = fmt(Math.round(( (rentMonthlyTotal*12 + otherMonthly*12) * mgmtPct )));
  document.getElementById('assetMgmtYr1').value = fmt(Math.round(( (rentMonthlyTotal*12 + otherMonthly*12) * assetPct )));

  // KPIs and returns
  const initialEquity = totalBasis - loan; // equity = total basis - loan
  // create cashflows for IRR: Year0 = -initialEquity, Year1..Year10 = ncf
  const cashflows = [-initialEquity].concat(ncf.map(v=>Math.round(v)));
  const noiYear10 = noi[9]||0; const noiYear11 = noiYear10 * 1.03; const exitCap = 0.045; const exitPrice = noiYear11 / exitCap; const sellingCosts = exitPrice * 0.02; const loanPayoff = loan; const netProceeds = exitPrice - sellingCosts - loanPayoff;
  cashflows[cashflows.length-1] += Math.round(netProceeds);
  const irrVal = irr(cashflows);
  const em = (ncf.reduce((a,b)=>a+b,0) + netProceeds)/initialEquity;
  const avgCoc = ((ncf.reduce((a,b)=>a+b,0)/10)/initialEquity)*100;

  document.getElementById('k_purchase').textContent = '$'+fmt(purchase);
  document.getElementById('k_equity').textContent = '$'+fmt(Math.round(initialEquity));
  document.getElementById('k_irr').textContent = isNaN(irrVal)?'—':((irrVal*100).toFixed(1)+'%');
  document.getElementById('k_em').textContent = isFinite(em)?em.toFixed(2)+'x':'—';
  document.getElementById('k_coc').textContent = isFinite(avgCoc)?avgCoc.toFixed(1)+'%':'—';
}

// wire up events
function attachEvents(){
  document.getElementById('recalcBtn').addEventListener('click',()=>recalc(false));
  document.getElementById('calcInBtn').addEventListener('click',calculateIn);
  document.getElementById('exportBtn').addEventListener('click',exportCSV);
  document.getElementById('resetBtn').addEventListener('click',()=>location.reload());
  document.querySelectorAll('#unitBody input').forEach(i=>i.addEventListener('input',updateUnitTotals));
  document.querySelectorAll('.input-yellow').forEach(i=>i.addEventListener('input',()=>{ /* live preview formulas */ recalc(false);}));
}

function exportCSV(){
  const rows = [];
  rows.push(['Line Item','Year1','Year2','Year3','Year4','Year5','Year6','Year7','Year8','Year9','Year10'].join(','));
  const tb = document.getElementById('proTable');
  for(let r=0;r<tb.tBodies[0].rows.length;r++){
    const row = tb.tBodies[0].rows[r]; const cols=[row.cells[0].textContent.trim().replace(/,/g,'')]; for(let c=1;c<row.cells.length;c++) cols.push(row.cells[c].textContent.trim().replace(/,/g,'')); rows.push(cols.join(',')); }
  const csv = rows.join('
'); const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='proforma_10yr.csv'; a.click(); URL.revokeObjectURL(url);
}

// init
attachEvents(); updateUnitTotals();
</script>
</body>
</html>
