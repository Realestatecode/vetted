<!doctype html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P4TD9G7W5V"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-P4TD9G7W5V');
</script>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>REAL ESTATE FINANCE MODEL</title>
<meta name="description" content="Multifamily | Apartment Real Estate Financial Model" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bank-blue: #0f1b2d;
    --bank-accent: #005eb8;
    --bg: #ffffff;
    --panel-bg: #ffffff;
    --border: #cbd5e1;
    --input-yellow: #fef9c3; /* Subtle yellow for inputs */
    --readonly: #f8fafc;
    --text-main: #0f172a;
    --text-muted: #64748b;
  }

  body { margin: 0; padding: 0; background: #f1f5f9; font-family: 'Inter', sans-serif; color: var(--text-main); -webkit-print-color-adjust: exact; }
  .wrap { max-width: 1000px; margin: 20px auto; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 30px; border-top: 6px solid var(--bank-blue); }

  /* --- TYPOGRAPHY & UTILS --- */
  h1, h2, h3, h4 { margin: 0; letter-spacing: -0.02em; }
  h3 { font-size: 14px; text-transform: uppercase; color: var(--text-muted); border-bottom: 2px solid var(--bank-blue); padding-bottom: 4px; margin-bottom: 12px; letter-spacing: 0.05em; font-weight: 700; }
  .logo-text { font-family: 'Times New Roman', serif; font-weight: bold; font-size: 24px; color: var(--bank-blue); }

  /* HIGHLIGHT REAL ESTATE EDGE */
  .edge-highlight {
    color: #dc2626;
    animation: edgeBlink 1.1s ease-in-out infinite alternate;
  }
  @keyframes edgeBlink {
    from { opacity: 1; }
    to   { opacity: 0.4; }
  }
  
  /* --- HEADER --- */
  header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0; }
  .controls button { background: white; border: 1px solid var(--border); padding: 6px 12px; font-size: 12px; font-weight: 600; color: var(--text-main); cursor: pointer; border-radius: 2px; transition: all 0.2s; }
  .controls button:hover { background: #f1f5f9; border-color: var(--bank-accent); }
  .controls button.primary { background: var(--bank-blue); color: white; border-color: var(--bank-blue); }
  .controls button.primary:hover { background: #1e3a8a; }

  /* --- GRID LAYOUTS --- */
  .input-grid { display: grid; grid-template-columns: 320px 1fr; gap: 25px; margin-bottom: 30px; }
  .section-box { margin-bottom: 20px; }
  
  /* --- INPUT ROWS --- */
  .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 12px; }
  .row label { color: var(--text-muted); font-weight: 500; }
  input { font-family: 'Roboto Mono', monospace; font-size: 12px; padding: 4px 6px; border: 1px solid var(--border); width: 100px; text-align: right; outline: none; border-radius: 0; }
  input:focus { border-color: var(--bank-accent); box-shadow: 0 0 0 1px var(--bank-accent); }
  input.yellow { background-color: var(--input-yellow); border-color: #e2e8f0; }
  input.readonly { background-color: var(--readonly); border: none; color: var(--text-main); font-weight: 600; }

  /* --- TABLES (Bank Style) --- */
  table { width: 100%; border-collapse: collapse; font-size: 11px; }
  th { text-align: left; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--text-muted); padding: 6px 4px; text-transform: uppercase; font-size: 10px; }
  td { padding: 6px 4px; border-bottom: 1px solid #f1f5f9; }
  td.num { text-align: right; font-family: 'Roboto Mono', monospace; }
  tr:last-child td { border-bottom: none; }
  tfoot td { border-top: 2px solid var(--text-muted); font-weight: 700; background: #f8fafc; }
  .highlight-row td { background-color: #f0f9ff; font-weight: 600; border-top: 1px solid #bae6fd; border-bottom: 1px solid #bae6fd; }

  /* --- UNIT INPUT TABLE --- */
  .unit-table input { width: 100%; box-sizing: border-box; border: none; background: transparent; text-align: center; }
  .unit-table input.yellow { background: var(--input-yellow); }
  .unit-table td { border: 1px solid #e2e8f0; padding: 0; }

  /* --- MIDDLE SECTION --- */
  .mid-section { 
    display: grid; 
    grid-template-columns: 1fr 200px 1fr; 
    gap: 10px; 
    align-items: center; 
    margin: 15px 0 5px; 
    text-align: center; 
  }
  
  /* CTA BOX */
  .cta-box { grid-column: 1 / -1; background: var(--bank-blue); color: white; padding: 10px; font-size: 13px; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 10px; border-radius: 2px; text-transform: uppercase; }
  .cta-box a { color: white; text-decoration: none; border-bottom: 1px dotted white; }

  /* VIDEO DROP */
  .video-drop { 
    height: 315px;               /* so the 16:9 YouTube embed fits cleanly */
    border: 2px dashed #94a3b8; 
    background: #f8fafc; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 12px; 
    color: #64748b; 
    font-weight: 600; 
    margin: 0 auto; 
    width: 100%; 
    max-width: 600px; 
    grid-column: 1 / -1; 
  }

  /* --- KPI CARDS --- */
  .kpi-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
  .kpi { background: #f8fafc; border: 1px solid var(--border); padding: 10px; text-align: center; }
  .kpi span { display: block; font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
  .kpi strong { font-size: 16px; color: var(--bank-blue); font-family: 'Roboto Mono', monospace; }

  /* --- FOOTER --- */
  footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center; font-size: 11px; color: var(--text-muted); line-height: 1.6; }
  footer a { color: var(--bank-accent); text-decoration: none; font-weight: 500; }
  footer a:hover { text-decoration: underline; }

  /* --- PRINT --- */
  @media print {
    body { background: white; }
    .wrap { box-shadow: none; margin: 0; padding: 0; border: none; width: 100%; max-width: 100%; }
    .controls, .cta-box { display: none; }
    .video-drop { border: 1px solid #ccc; height: 200px; }
    input { border: none; padding: 0; background: transparent !important; text-align: right; }
    .input-grid { gap: 20px; }
    h3 { font-size: 12px; border-bottom: 1px solid #000; color: #000; }
    table { font-size: 9px; }
    th { color: #000; border-color: #000; }
  }
</style>
</head>
<body>

<div class="wrap">
  
  <!-- LOGO ROW -->
  <header>
    <div class="logo-text">REALFIMO<span style="font-weight:400; font-size:16px; color:#64748b;">| Real Estate Finance Model Analytics</span></div>
    <div class="controls">
      <button id="btnReset">Reset</button>
      <button class="primary" id="btnCalcIn">Copy In-Place Rents</button>
      <button class="primary" id="btnExport">Export CSV</button>
    </div>
  </header>

  <!-- INPUTS GRID -->
  <div class="input-grid">
    
    <!-- LEFT: ASSUMPTIONS -->
    <div class="left-panel">
      <div class="section-box">
        <h3>1. Deal Assumptions (Inputs)</h3>
        <div class="row"><label>Project Name</label><input id="i_name" type="text" class="yellow" style="text-align:left; width:140px" value="Project xyz"></div>
        <div class="row"><label>Purchase Price</label><input id="i_price" type="text" class="yellow" value="20,000,000"></div>
        <div class="row"><label>Closing Costs %</label><input id="i_close" type="number" class="yellow" value="1.0"></div>
        <div class="row"><label>Reno Budget</label><input id="i_reno" type="text" class="yellow" value="500,000"></div>
        <div class="row"><label><strong>Total Basis</strong></label><input id="o_basis" class="readonly" readonly></div>
      </div>

      <div class="section-box">
        <h3>2. Financing</h3>
        <div class="row"><label>LTV %</label><input id="i_ltv" type="number" class="yellow" value="60.0"></div>
        <div class="row"><label>Interest Rate %</label><input id="i_rate" type="number" class="yellow" value="5.50"></div>
        <div class="row"><label>Amortization (Yrs)</label><input id="i_amort" type="number" class="yellow" value="30"></div>
        <div class="row"><label>Loan Amount</label><input id="o_loan" class="readonly" readonly></div>
        <div class="row"><label>Annual Debt Service</label><input id="o_debt" class="readonly" readonly></div>
      </div>

      <div class="section-box">
        <h3>3. OpEx & Growth (Year 1)</h3>
        <div class="row"><label>Prop Taxes (% Price)</label><input id="i_tax" type="number" class="yellow" value="1.25"></div>
        <div class="row"><label>Insurance ($/unit)</label><input id="i_ins" type="number" class="yellow" value="500"></div>
        <div class="row"><label>Mgmt Fee (% EGI)</label><input id="i_mgmt" type="number" class="yellow" value="4.0"></div>
        <div class="row"><label>R&amp;M / Utilities ($/u)</label><input id="i_rm_util" type="number" class="yellow" value="1350"></div>
        <!-- NEW FIXED OPEX LINE ITEM -->
        <div class="row"><label>Fixed OpEx ($/yr)</label><input id="i_fixed_opex" type="number" class="yellow" value="0"></div>
        <div class="row"><label>Other Income ($/mo)</label><input id="i_other" type="number" class="yellow" value="10500"></div>
        <div class="row"><label>Vacancy / Growth %</label><input id="i_vac_gro" type="number" class="yellow" value="5.0"></div>
      </div>
    </div>

    <!-- RIGHT: UNIT MIX -->
    <div class="right-panel">
      <h3>4. Unit Mix Analysis</h3>
      <table class="unit-table">
        <thead>
          <tr>
            <th style="width:30%">Type</th>
            <th style="width:12%">Cnt</th>
            <th style="width:12%">SqFt</th>
            <th style="width:18%">In-Place</th>
            <th style="width:18%; background:#fefce8; color:#b45309">Pro Forma</th>
            <th style="width:20%">Total/Mo</th>
          </tr>
        </thead>
        <tbody id="unitBody">
          <!-- Rows Generated by JS below, but hardcoded structure for stability -->
          <tr>
            <td><input type="text" value="Studio/Loft" readonly></td>
            <td><input class="yellow u-cnt" type="number" value="8"></td>
            <td><input class="yellow u-sq" type="number" value="600"></td>
            <td><input class="yellow u-cur" type="number" value="1026"></td>
            <td><input class="yellow u-pro" type="number" value="1600"></td>
            <td class="num u-tot" style="padding-right:6px; vertical-align:middle">0</td>
          </tr>
          <tr>
            <td><input type="text" value="Studio" readonly></td>
            <td><input class="yellow u-cnt" type="number" value="8"></td>
            <td><input class="yellow u-sq" type="number" value="650"></td>
            <td><input class="yellow u-cur" type="number" value="2603"></td>
            <td><input class="yellow u-pro" type="number" value="2800"></td>
            <td class="num u-tot" style="padding-right:6px; vertical-align:middle">0</td>
          </tr>
          <tr>
            <td><input type="text" value="1 Bedroom" readonly></td>
            <td><input class="yellow u-cnt" type="number" value="12"></td>
            <td><input class="yellow u-sq" type="number" value="750"></td>
            <td><input class="yellow u-cur" type="number" value="3601"></td>
            <td><input class="yellow u-pro" type="number" value="3800"></td>
            <td class="num u-tot" style="padding-right:6px; vertical-align:middle">0</td>
          </tr>
          <tr>
            <td><input type="text" value="2 Bedroom" readonly></td>
            <td><input class="yellow u-cnt" type="number" value="15"></td>
            <td><input class="yellow u-sq" type="number" value="900"></td>
            <td><input class="yellow u-cur" type="number" value="4375"></td>
            <td><input class="yellow u-pro" type="number" value="4600"></td>
            <td class="num u-tot" style="padding-right:6px; vertical-align:middle">0</td>
          </tr>
          <tr>
            <td><input type="text" value="3 Bedroom" readonly></td>
            <td><input class="yellow u-cnt" type="number" value="7"></td>
            <td><input class="yellow u-sq" type="number" value="1200"></td>
            <td><input class="yellow u-cur" type="number" value="5050"></td>
            <td><input class="yellow u-pro" type="number" value="5300"></td>
            <td class="num u-tot" style="padding-right:6px; vertical-align:middle">0</td>
          </tr>
        </tbody>
        <tfoot>
          <!-- FOOTER WITH TOTAL UNITS & TOTAL SQFT -->
          <tr>
            <td style="text-align:right; padding-right:4px; font-weight:600;">TOTALS:</td>
            <td class="num" id="t_units">0</td>
            <td class="num" id="t_sqft">0</td>
            <td class="num" id="t_cur">0</td>
            <td class="num" id="t_pro">0</td>
            <td class="num" id="t_tot" style="background:#f0fdf4; color:#166534">0</td>
          </tr>
        </tfoot>
      </table>
      
      <div style="margin-top:15px; font-size:11px; color:#64748b; line-height:1.4">
        * <strong>Total/Mo Formula:</strong> Pro Forma Rent × Unit Count.<br>
        * Pro Forma model below annualizes this figure (×12).
      </div>

      <!-- 4B. COMMERCIAL LEASES / RETAIL -->
      <div class="section-box" style="margin-top:20px;">
        <h3>4B. Commercial Leases (Ground Floor / Retail)</h3>
        <table class="unit-table">
          <thead>
            <tr>
              <th style="width:28%">Space</th>
              <th style="width:10%">Units</th>
              <th style="width:16%">SqFt</th>
              <th style="width:18%">In-Place Rent</th>
              <th style="width:18%; background:#fefce8; color:#b45309">Market Rent</th>
              <th style="width:10%">Growth %</th>
              <th style="width:20%">Total/Mo</th>
            </tr>
          </thead>
          <tbody id="commBody">
            <tr>
              <td><input type="text" value="Retail 1"></td>
              <td><input class="yellow c-unit" type="number" value="1"></td>
              <td><input class="yellow c-sq" type="number" value="2500"></td>
              <td><input class="yellow c-cur" type="number" value="5000"></td>
              <td><input class="yellow c-mkt" type="number" value="6000"></td>
              <td><input class="yellow c-gro" type="number" value="3.0"></td>
              <td class="num c-tot" style="padding-right:6px; vertical-align:middle">0</td>
            </tr>
            <tr>
              <td><input type="text" value="Retail 2"></td>
              <td><input class="yellow c-unit" type="number" value="1"></td>
              <td><input class="yellow c-sq" type="number" value=""></td>
              <td><input class="yellow c-cur" type="number" value=""></td>
              <td><input class="yellow c-mkt" type="number" value=""></td>
              <td><input class="yellow c-gro" type="number" value="3.0"></td>
              <td class="num c-tot" style="padding-right:6px; vertical-align:middle">0</td>
            </tr>
            <tr>
              <td><input type="text" value="Retail 3"></td>
              <td><input class="yellow c-unit" type="number" value="1"></td>
              <td><input class="yellow c-sq" type="number" value=""></td>
              <td><input class="yellow c-cur" type="number" value=""></td>
              <td><input class="yellow c-mkt" type="number" value=""></td>
              <td><input class="yellow c-gro" type="number" value="3.0"></td>
              <td class="num c-tot" style="padding-right:6px; vertical-align:middle">0</td>
            </tr>
            <tr>
              <td><input type="text" value="Retail 4"></td>
              <td><input class="yellow c-unit" type="number" value="1"></td>
              <td><input class="yellow c-sq" type="number" value=""></td>
              <td><input class="yellow c-cur" type="number" value=""></td>
              <td><input class="yellow c-mkt" type="number" value=""></td>
              <td><input class="yellow c-gro" type="number" value="3.0"></td>
              <td class="num c-tot" style="padding-right:6px; vertical-align:middle">0</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td style="text-align:right; padding-right:4px; font-weight:600;">TOTALS:</td>
              <td class="num" id="c_units_total">0</td>
              <td class="num" id="c_sqft_total">0</td>
              <td></td>
              <td></td>
              <td></td>
              <td class="num" id="c_tot_monthly" style="background:#f0fdf4; color:#166534">0</td>
            </tr>
          </tfoot>
        </table>
        <div style="margin-top:10px; font-size:11px; color:#64748b; line-height:1.4">
          <div class="row" style="justify-content:space-between; margin-bottom:4px;">
            <label>Retail 3-Year Cash Flow</label>
            <input id="retail3" class="readonly" readonly style="width:120px;">
          </div>
          <div class="row" style="justify-content:space-between;">
            <label>Retail 5-Year Cash Flow</label>
            <input id="retail5" class="readonly" readonly style="width:120px;">
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- CTA BAR -->
  <div class="cta-box">
    Contact 310.728.7974 for Real Estate Asset Management & Underwriting Multifamily | Office | Retail | Net Lease | Hotel Real Estate Edge <a href="https://realestatecode.github.io/vetted" target="_blank">realestatecode.github.io/vetted</a>
  </div>

  <!-- MIDDLE LOGO & VIDEO -->
  <div class="mid-section">
    <div style="border-bottom: 1px solid #e2e8f0; height:1px"></div>
    <div class="logo-text edge-highlight" style="font-size:20px">REAL ESTATE EDGE</div>
    <div style="border-bottom: 1px solid #e2e8f0; height:1px"></div>
  </div>
  
  <div class="video-drop">
    <iframe width="560" height="315"
      src="https://www.youtube.com/embed/8zhx59oxXy4"
      title="YouTube video player"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen
      style="width:100%; height:100%;">
    </iframe>
  </div>

  <!-- PRO FORMA ENGINE -->
  <div class="section-box" style="margin-top:20px;">
    <h3>5. 10-Year Pro Forma Projection (for illustration only - for complex projects - investors are expected to perform their own due diligience as interest rate, occupancy and market conditions can change and will impact financial outlook.</h3>
    
    <div class="kpi-row">
      <div class="kpi"><span>Initial Equity</span><strong id="k_eq">-</strong></div>
      <div class="kpi"><span>IRR (Levered)</span><strong id="k_irr">-</strong></div>
      <div class="kpi"><span>Equity Multiple</span><strong id="k_em">-</strong></div>
      <div class="kpi"><span>Avg Cash/Cash</span><strong id="k_coc">-</strong></div>
      <div class="kpi"><span>Exit Price (Yr10)</span><strong id="k_exit">-</strong></div>
    </div>

    <div style="overflow-x:auto">
      <table id="proTable">
        <thead>
          <!-- JS Populated -->
        </thead>
        <tbody>
          <!-- JS Populated -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <div><a href="https://www.coffeebarconnoisseur.com">coffeebarconnoisseur.com</a> · <a href="https://www.coffeebarroasters.com">coffeebarroasters.com</a> · <a href="https://www.dividond.com">dividond.com</a> · <a href="https://www.decodedmusic.com">decodedmusic.com</a></div>
    <div style="margin-top:6px"><a href="https://www.youtube.com/@designrenovate">YouTube — DesignRenovate</a></div>
  </footer>

</div>

<script>
/* --- HELPERS --- */
const $ = id => document.getElementById(id);
const toNum = val => parseFloat(String(val).replace(/[,\$]/g,'')) || 0;
const fmt = (n, d=0) => n.toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});

/* --- FINANCIAL MATH --- */
function PMT(rate, nper, pv) {
  if(!rate) return -(pv/nper);
  const r = rate/12; 
  const n = nper*12;
  return - (pv * r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
}

function IRR(values, guess=0.1) {
  const maxIter = 1000; const tol = 1e-6;
  let x0 = guess;
  for(let i=0; i<maxIter; i++){
    let f=0, df=0;
    for(let j=0; j<values.length; j++){
      f += values[j]/Math.pow(1+x0, j);
      df += -j*values[j]/Math.pow(1+x0, j+1);
    }
    let x1 = x0 - f/df;
    if(Math.abs(x1-x0) < tol) return x1;
    x0 = x1;
  }
  return 0;
}

/* --- MAIN CALCULATION --- */
function calculate() {
  const years = 10;

  // 1. Residential Unit Mix Logic
  let resMonthly = 0;
  let totalCur = 0, totalPro = 0;
  let unitCount = 0;
  let unitSqft = 0;

  document.querySelectorAll('#unitBody tr').forEach(row => {
    const cnt = toNum(row.querySelector('.u-cnt').value);
    const sfPerUnit = toNum(row.querySelector('.u-sq').value);
    const cur = toNum(row.querySelector('.u-cur').value);
    const pro = toNum(row.querySelector('.u-pro').value);
    
    const lineTotal = pro * cnt;
    row.querySelector('.u-tot').textContent = fmt(lineTotal);
    
    resMonthly += lineTotal;
    totalCur += cur * cnt;
    totalPro += pro * cnt;
    unitCount += cnt;
    unitSqft += sfPerUnit * cnt;
  });
  
  $('t_units').textContent = fmt(unitCount);
  $('t_sqft').textContent = fmt(unitSqft);
  $('t_cur').textContent = fmt(totalCur);
  $('t_pro').textContent = fmt(totalPro);
  $('t_tot').textContent = fmt(resMonthly);

  // 1B. Commercial / Retail Leases
  let retailAnnual = new Array(years).fill(0);
  let retailUnits = 0;
  let retailSqft = 0;
  let retailMonthlyY1 = 0;

  document.querySelectorAll('#commBody tr').forEach(row => {
    const cUnits = toNum(row.querySelector('.c-unit').value);
    const cSqft = toNum(row.querySelector('.c-sq').value);
    const curRent = toNum(row.querySelector('.c-cur').value);
    const mktRent = toNum(row.querySelector('.c-mkt').value);
    const gRate = toNum(row.querySelector('.c-gro').value) / 100;

    const baseRent = mktRent || curRent;
    const lineMonthlyY1 = baseRent * cUnits;
    row.querySelector('.c-tot').textContent = fmt(lineMonthlyY1);

    retailUnits += cUnits;
    retailSqft += cSqft * cUnits;
    retailMonthlyY1 += lineMonthlyY1;

    for(let y=1; y<=years; y++) {
      const factor = Math.pow(1+gRate, y-1);
      retailAnnual[y-1] += lineMonthlyY1 * 12 * factor;
    }
  });

  $('c_units_total').textContent = fmt(retailUnits);
  $('c_sqft_total').textContent = fmt(retailSqft);
  $('c_tot_monthly').textContent = fmt(retailMonthlyY1);

  const retail3 = retailAnnual.slice(0,3).reduce((a,b)=>a+b,0);
  const retail5 = retailAnnual.slice(0,5).reduce((a,b)=>a+b,0);
  $('retail3').value = '$' + fmt(retail3);
  $('retail5').value = '$' + fmt(retail5);

  // 2. Acquisition & Debt
  const price = toNum($('i_price').value);
  const close = price * (toNum($('i_close').value)/100);
  const reno = toNum($('i_reno').value);
  const basis = price + close + reno;
  $('o_basis').value = fmt(basis);

  const loan = price * (toNum($('i_ltv').value)/100);
  $('o_loan').value = fmt(loan);
  
  const rate = toNum($('i_rate').value)/100;
  const amort = toNum($('i_amort').value);
  let annualDebt = 0;
  if(amort > 0) {
    annualDebt = Math.abs(PMT(rate, amort, loan)) * 12;
  } else {
    annualDebt = loan * rate;
  }
  $('o_debt').value = fmt(annualDebt);

  // 3. 10-Year Pro Forma (Residential + Retail)
  const growth = toNum($('i_vac_gro').value)/100;
  const vacancyRate = growth;
  const otherIncMo = toNum($('i_other').value);
  const taxStart = price * (toNum($('i_tax').value)/100);
  
  let insStart = toNum($('i_ins').value) * unitCount;
  let rmStart = toNum($('i_rm_util').value) * unitCount;
  let fixedOpexStart = toNum($('i_fixed_opex').value);
  const mgmtPct = toNum($('i_mgmt').value)/100;

  let d_resGpr = [], d_retail = [], d_other = [], d_vac = [], d_egi = [], d_exp = [], d_noi = [], d_cf = [];

  for(let y=1; y<=years; y++) {
    const gf = Math.pow(1.03, y-1);
    const rg = Math.pow(1+growth, y-1);

    const resGpr = (resMonthly * 12) * rg;
    const retInc = retailAnnual[y-1];
    const other = (otherIncMo * 12) * rg;
    const gprTotal = resGpr + retInc;
    const vac = -(gprTotal + other) * vacancyRate;
    const egi = gprTotal + other + vac;

    const tax = taxStart * gf;
    const ins = insStart * gf;
    const rm = rmStart * gf;
    const fixed = fixedOpexStart * gf;
    const mgmt = egi * mgmtPct;
    const totalExp = tax + ins + rm + fixed + mgmt;

    const noi = egi - totalExp;
    const cf = noi - annualDebt;

    d_resGpr.push(resGpr);
    d_retail.push(retInc);
    d_other.push(other);
    d_vac.push(vac);
    d_egi.push(egi);
    d_exp.push(totalExp);
    d_noi.push(noi);
    d_cf.push(cf);
  }

  renderTable(d_resGpr, d_retail, d_other, d_vac, d_egi, d_exp, d_noi, annualDebt, d_cf);
  updateKPIs(basis, loan, d_cf, d_noi[9]);
}

function renderTable(gprRes, retail, other, vac, egi, exp, noi, debt, cf) {
  const thead = $('proTable').querySelector('thead');
  const tbody = $('proTable').querySelector('tbody');
  
  let h = `<tr><th style="min-width:140px">Item</th>`;
  for(let i=1; i<=10; i++) h += `<th>Year ${i}</th>`;
  h += `</tr>`;
  thead.innerHTML = h;

  const mkRow = (lbl, data, cls='') => {
    let r = `<tr class="${cls}"><td>${lbl}</td>`;
    data.forEach(v => r += `<td class="num">${fmt(v)}</td>`);
    return r + `</tr>`;
  };

  let b = '';
  b += mkRow('Gross Potential Rent (Res)', gprRes);
  b += mkRow('Retail Income', retail, 'highlight-row');
  b += mkRow('Other Income', other);
  b += mkRow('Vacancy (Loss)', vac);
  b += mkRow('Effective Gross Inc', egi, 'highlight-row');
  b += mkRow('Total Expenses', exp.map(x=>-x));
  b += mkRow('Net Operating Income', noi, 'highlight-row');
  b += mkRow('Debt Service', Array(10).fill(-debt));
  b += mkRow('CASH FLOW', cf, 'highlight-row');
  
  tbody.innerHTML = b;
}

function updateKPIs(basis, loan, cfs, noi10) {
  const equity = basis - loan;
  $('k_eq').textContent = '$' + fmt(equity);

  const cap = 0.05;
  const exitPrice = noi10 / cap;
  const netSale = exitPrice * 0.98 - loan;
  
  let stream = [-equity, ...cfs];
  stream[10] += netSale;
  
  const irr = IRR(stream);
  const mult = (cfs.reduce((a,b)=>a+b,0) + netSale) / equity;
  const avgCoc = (cfs.reduce((a,b)=>a+b,0)/10) / equity;

  $('k_irr').textContent = (irr*100).toFixed(2) + '%';
  $('k_em').textContent = mult.toFixed(2) + 'x';
  $('k_coc').textContent = (avgCoc*100).toFixed(2) + '%';
  $('k_exit').textContent = '$' + fmt(exitPrice);
}

/* --- EVENTS --- */
document.addEventListener('DOMContentLoaded', () => {
  const inputs = document.querySelectorAll('input');
  inputs.forEach(i => i.addEventListener('input', calculate));

  $('btnCalcIn').addEventListener('click', () => {
    // Copy in-place residential rents to pro forma
    document.querySelectorAll('#unitBody tr').forEach(r => {
      const cur = r.querySelector('.u-cur').value;
      if(cur) r.querySelector('.u-pro').value = cur;
    });
    // Copy in-place retail rents to market where desired
    document.querySelectorAll('#commBody tr').forEach(r => {
      const cur = r.querySelector('.c-cur').value;
      if(cur) r.querySelector('.c-mkt').value = cur;
    });
    calculate();
  });
  
  $('btnReset').addEventListener('click', () => location.reload());

  $('btnExport').addEventListener('click', () => {
    let csv = [];
    document.querySelectorAll('#proTable tr').forEach(tr => {
      let cols = Array.from(tr.querySelectorAll('td,th')).map(td => '"'+td.innerText.replace(/,/g,'')+'"');
      csv.push(cols.join(','));
    });
    const blob = new Blob([csv.join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='jpm_model_export.csv'; a.click();
  });

  calculate(); // Init
});
</script>
</body>
</html>
