<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Comprehensive 50-Unit REI Model — Compact Print</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#ffffff;--accent:#2b6cb0;--muted:#64748b;--yellow:#FFF9DB;--formula:#f3f6fb}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:#0f172a}
  .wrap{max-width:1000px;margin:12px auto;padding:12px}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{font-size:18px;margin:0}
  .controls{display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(90deg,#3b82f6,#06b6d4);color:white}
  .layout{display:grid;grid-template-columns: 420px 1fr;gap:12px;margin-top:12px}
  .panel{border-radius:8px;padding:10px;border:1px solid #e6eef8;background:#fff}
  .compact-row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;font-size:13px}
  label{font-size:12px;color:var(--muted);margin-right:8px}
  input[type=number], input[type=text], select{padding:6px;border-radius:6px;border:1px solid #e6eef8;width:120px}
  .small{font-size:12px;color:var(--muted)}
  .units-table{width:100%;border-collapse:collapse;margin-top:6px}
  .units-table th,.units-table td{padding:6px;border-bottom:1px solid #f3f6fb;font-size:12px}
  .units-table td input{width:70px}
  .units-table td.input{background:var(--yellow)}
  .formula{background:var(--formula)}
  /* proforma */
  .proforma{margin-top:12px;overflow:auto}
  table.pro{border-collapse:collapse;width:100%;min-width:900px}
  table.pro th, table.pro td{padding:6px;border:1px solid #eef4fb;font-size:12px;text-align:right}
  table.pro th{background:#fbfdff;color:var(--muted);text-align:left}
  .kpis{display:flex;gap:8px;margin-top:10px}
  .kpi{flex:1;padding:10px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfdff);text-align:center}
  .kpi h3{margin:0;font-size:14px}
  .kpi p{margin:6px 0 0;font-weight:800}
  /* print */
  @media print{
    body{background:white}
    .layout{grid-template-columns:1fr 1fr}
    .controls, .btn{display:none}
    .wrap{max-width:8.5in}
    table.pro{font-size:10px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Comprehensive 50-Unit REI Model — Compact Print</h1>
      <div class="small">Inputs left • Units right • Pro Forma and Dashboard below • Print-friendly (Letter)</div>
    </div>
    <div class="controls">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn primary" id="recalcBtn">Recalculate</button>
      <button class="btn" id="exportBtn">Export CSV</button>
    </div>
  </header>

  <div class="layout">
    <!-- Left: Inputs -->
    <div class="panel" style="height:fit-content">
      <h3 style="margin:0 0 6px">TAB 1 — INPUTS</h3>
      <div class="small">Edit ONLY yellow inputs. Grey fields are formulas.</div>

      <div style="margin-top:8px">
        <div class="compact-row"><label>Project Name</label><input id="projectName" type="text" value="xyz"></div>
        <div class="compact-row"><label>Total Units</label><input id="totalUnits" type="number" value="50"></div>
        <div class="compact-row"><label>Rentable Sq Ft</label><input id="rentableSqft" type="number" value="51745"></div>
        <div class="compact-row"><label>Purchase Price</label><input id="purchasePrice" type="number" value="20000000"></div>
        <div class="compact-row"><label>Closing Costs %</label><input id="closingPct" type="number" value="1"></div>
        <div class="compact-row"><label>Renovation Budget</label><input id="renovation" type="number" value="500000"></div>
        <div class="compact-row"><label>Total Initial Basis</label><input id="totalBasis" class="formula" readonly value="20700000"></div>
        <hr>
        <div class="compact-row"><label>LTV %</label><input id="ltv" type="number" value="60"></div>
        <div class="compact-row"><label>Interest Rate %</label><input id="interestRate" type="number" value="5.5"></div>
        <div class="compact-row"><label>Amortization (yrs)</label><input id="amortYears" type="number" value="30"></div>
        <div class="compact-row"><label>Loan Term (yrs)</label><input id="loanTerm" type="number" value="10"></div>
        <div class="compact-row"><label>Loan Amount</label><input id="loanAmount" class="formula" readonly value="12000000"></div>
        <hr>
        <div class="compact-row"><label>Other Income (monthly)</label><input id="otherIncome" type="number" value="10500"></div>
        <div class="compact-row"><label>Vacancy %</label><input id="vacancy" type="number" value="5"></div>
        <div class="compact-row"><label>Rent Growth %</label><input id="rentGrowth" type="number" value="5"></div>
        <div class="compact-row"><label>Expense Growth %</label><input id="expenseGrowth" type="number" value="3"></div>
        <hr>
        <div class="compact-row"><label>Improvement %</label><input id="improvePct" type="number" value="75"></div>
        <div class="compact-row"><label>Investor Tax Rate %</label><input id="taxRate" type="number" value="35"></div>
      </div>
    </div>

    <!-- Right: Unit Mix -->
    <div class="panel">
      <h3 style="margin:0 0 6px">Unit Mix & Income (Yellow = editable)</h3>
      <table class="units-table">
        <thead><tr><th>Unit Type</th><th>Count</th><th>Sq Ft</th><th>Current Rent</th><th>Pro Forma Rent</th><th>Monthly Total</th></tr></thead>
        <tbody id="unitBody">
          <tr><td>Studio/Loft</td><td class="input"><input class="u-count" type="number" value="8"></td><td class="input"><input class="u-sqft" type="number" value="600"></td><td class="input"><input class="u-cur" type="number" value="1026"></td><td class="input"><input class="u-pro" type="number" value="1600"></td><td class="formula right">8208</td></tr>
          <tr><td>Studio</td><td class="input"><input class="u-count" type="number" value="8"></td><td class="input"><input class="u-sqft" type="number" value="650"></td><td class="input"><input class="u-cur" type="number" value="2603"></td><td class="input"><input class="u-pro" type="number" value="2800"></td><td class="formula right">20824</td></tr>
          <tr><td>1BR</td><td class="input"><input class="u-count" type="number" value="12"></td><td class="input"><input class="u-sqft" type="number" value="750"></td><td class="input"><input class="u-cur" type="number" value="3601"></td><td class="input"><input class="u-pro" type="number" value="3800"></td><td class="formula right">43212</td></tr>
          <tr><td>2BR</td><td class="input"><input class="u-count" type="number" value="15"></td><td class="input"><input class="u-sqft" type="number" value="900"></td><td class="input"><input class="u-cur" type="number" value="4375"></td><td class="input"><input class="u-pro" type="number" value="4600"></td><td class="formula right">65625</td></tr>
          <tr><td>3BR</td><td class="input"><input class="u-count" type="number" value="7"></td><td class="input"><input class="u-sqft" type="number" value="1200"></td><td class="input"><input class="u-cur" type="number" value="5050"></td><td class="input"><input class="u-pro" type="number" value="5300"></td><td class="formula right">35350</td></tr>
        </tbody>
        <tfoot>
          <tr><td><strong>TOTALS</strong></td><td id="unitTotal" class="formula">50</td><td id="sqftTotal" class="formula">51745</td><td></td><td></td><td id="rentTotal" class="formula">173219</td></tr>
        </tfoot>
      </table>

      <div style="margin-top:8px;font-size:12px" class="small">Operating Expenses (Yr1)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px">
        <div class="compact-row"><label>Prop Taxes %</label><input id="propTaxPct" type="number" value="1.25"></div>
        <div class="compact-row"><label>Insurance $/unit/yr</label><input id="insPerUnit" type="number" value="500"></div>
        <div class="compact-row"><label>Mgmt Fee % of EGI</label><input id="mgmtPct" type="number" value="4"></div>
        <div class="compact-row"><label>Repairs $/unit/yr</label><input id="repairsPerUnit" type="number" value="750"></div>
        <div class="compact-row"><label>Utilities $/unit/yr</label><input id="utilPerUnit" type="number" value="600"></div>
        <div class="compact-row"><label>Turn/Leasing $/unit/yr</label><input id="turnPerUnit" type="number" value="200"></div>
        <div class="compact-row"><label>Asset Mgmt % of EGI</label><input id="assetPct" type="number" value="1"></div>
      </div>
    </div>

    <!-- Pro Forma / Dashboard (full-width below) -->
    <div style="grid-column:1 / -1">
      <div class="panel proforma">
        <h3 style="margin:0 0 6px">TAB 2 — PRO FORMA (Years 1–10)</h3>
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Scroll horizontally for years. Grey = formula cells generated from inputs.</div>

        <table class="pro" id="proTable">
          <thead>
            <tr><th>Line Item</th>
              <th>Year 1</th><th>Year 2</th><th>Year 3</th><th>Year 4</th><th>Year 5</th>
              <th>Year 6</th><th>Year 7</th><th>Year 8</th><th>Year 9</th><th>Year 10</th>
            </tr>
          </thead>
          <tbody>
            <tr><th style="text-align:left">Gross Potential Rent</th><td class="formula" id="gpr1">2078628</td><td class="formula" id="gpr2">2182559</td><td class="formula" id="gpr3">2291687</td><td class="formula" id="gpr4">2406271</td><td class="formula" id="gpr5">2526585</td><td class="formula" id="gpr6">2652914</td><td class="formula" id="gpr7">2785559</td><td class="formula" id="gpr8">2924837</td><td class="formula" id="gpr9">3071079</td><td class="formula" id="gpr10">3224633</td></tr>
            <tr><th style="text-align:left">(+) Other Income</th><td class="formula" id="oi1">126000</td><td class="formula" id="oi2">132300</td><td class="formula" id="oi3">139115</td><td class="formula" id="oi4">145,....</td><td class="formula" id="oi5"></td><td class="formula" id="oi6"></td><td class="formula" id="oi7"></td><td class="formula" id="oi8"></td><td class="formula" id="oi9"></td><td class="formula" id="oi10"></td></tr>
            <tr><th style="text-align:left">(-) Vacancy Loss</th><td class="formula" id="vac1">-110231</td><td class="formula" id="vac2">-115743</td><td class="formula" id="vac3"></td><td class="formula" id="vac4"></td><td class="formula" id="vac5"></td><td class="formula" id="vac6"></td><td class="formula" id="vac7"></td><td class="formula" id="vac8"></td><td class="formula" id="vac9"></td><td class="formula" id="vac10"></td></tr>
            <tr><th style="text-align:left">= Effective Gross Income</th><td class="formula" id="egi1">2094397</td><td class="formula" id="egi2">2199116</td><td class="formula" id="egi3"></td><td class="formula" id="egi4"></td><td class="formula" id="egi5"></td><td class="formula" id="egi6"></td><td class="formula" id="egi7"></td><td class="formula" id="egi8"></td><td class="formula" id="egi9"></td><td class="formula" id="egi10"></td></tr>
            <tr><th style="text-align:left">Property Taxes</th><td class="formula" id="tax1">250000</td><td class="formula" id="tax2">257500</td><td class="formula" id="tax3"></td><td class="formula" id="tax4"></td><td class="formula" id="tax5"></td><td class="formula" id="tax6"></td><td class="formula" id="tax7"></td><td class="formula" id="tax8"></td><td class="formula" id="tax9"></td><td class="formula" id="tax10"></td></tr>
            <tr><th style="text-align:left">Insurance</th><td class="formula" id="ins1">25000</td><td class="formula" id="ins2">25750</td><td class="formula" id="ins3"></td><td class="formula" id="ins4"></td><td class="formula" id="ins5"></td><td class="formula" id="ins6"></td><td class="formula" id="ins7"></td><td class="formula" id="ins8"></td><td class="formula" id="ins9"></td><td class="formula" id="ins10"></td></tr>
            <tr><th style="text-align:left">Management Fee</th><td class="formula" id="mgmt1">83776</td><td class="formula" id="mgmt2">87965</td><td class="formula" id="mgmt3"></td><td class="formula" id="mgmt4"></td><td class="formula" id="mgmt5"></td><td class="formula" id="mgmt6"></td><td class="formula" id="mgmt7"></td><td class="formula" id="mgmt8"></td><td class="formula" id="mgmt9"></td><td class="formula" id="mgmt10"></td></tr>
            <tr><th style="text-align:left">Repairs & Maint</th><td class="formula" id="rep1">37500</td><td class="formula" id="rep2">38625</td><td class="formula" id="rep3"></td><td class="formula" id="rep4"></td><td class="formula" id="rep5"></td><td class="formula" id="rep6"></td><td class="formula" id="rep7"></td><td class="formula" id="rep8"></td><td class="formula" id="rep9"></td><td class="formula" id="rep10"></td></tr>
            <tr><th style="text-align:left">Utilities</th><td class="formula" id="util1">30000</td><td class="formula" id="util2">30900</td><td class="formula" id="util3"></td><td class="formula" id="util4"></td><td class="formula" id="util5"></td><td class="formula" id="util6"></td><td class="formula" id="util7"></td><td class="formula" id="util8"></td><td class="formula" id="util9"></td><td class="formula" id="util10"></td></tr>
            <tr><th style="text-align:left">Asset Mgmt / Other</th><td class="formula" id="asset1">20944</td><td class="formula" id="asset2">21991</td><td class="formula" id="asset3"></td><td class="formula" id="asset4"></td><td class="formula" id="asset5"></td><td class="formula" id="asset6"></td><td class="formula" id="asset7"></td><td class="formula" id="asset8"></td><td class="formula" id="asset9"></td><td class="formula" id="asset10"></td></tr>
            <tr><th style="text-align:left">= Total Expenses</th><td class="formula" id="totexp1">447220</td><td class="formula" id="totexp2">462731</td><td class="formula" id="totexp3"></td><td class="formula" id="totexp4"></td><td class="formula" id="totexp5"></td><td class="formula" id="totexp6"></td><td class="formula" id="totexp7"></td><td class="formula" id="totexp8"></td><td class="formula" id="totexp9"></td><td class="formula" id="totexp10"></td></tr>
            <tr><th style="text-align:left">= NOI</th><td class="formula" id="noi1">1647177</td><td class="formula" id="noi2">1736385</td><td class="formula" id="noi3"></td><td class="formula" id="noi4"></td><td class="formula" id="noi5"></td><td class="formula" id="noi6"></td><td class="formula" id="noi7"></td><td class="formula" id="noi8"></td><td class="formula" id="noi9"></td><td class="formula" id="noi10"></td></tr>
            <tr><th style="text-align:left">(-) Debt Service</th><td class="formula" id="debt1">-660000</td><td class="formula" id="debt2">-660000</td><td class="formula" id="debt3"></td><td class="formula" id="debt4"></td><td class="formula" id="debt5"></td><td class="formula" id="debt6"></td><td class="formula" id="debt7"></td><td class="formula" id="debt8"></td><td class="formula" id="debt9"></td><td class="formula" id="debt10"></td></tr>
            <tr><th style="text-align:left">(-) Capital Reserves</th><td class="formula" id="capres1">-12500</td><td class="formula" id="capres2">-12500</td><td class="formula" id="capres3"></td><td class="formula" id="capres4"></td><td class="formula" id="capres5"></td><td class="formula" id="capres6"></td><td class="formula" id="capres7"></td><td class="formula" id="capres8"></td><td class="formula" id="capres9"></td><td class="formula" id="capres10"></td></tr>
            <tr><th style="text-align:left">= Cash Flow After Debt</th><td class="formula" id="cf1">974677</td><td class="formula" id="cf2">1063885</td><td class="formula" id="cf3"></td><td class="formula" id="cf4"></td><td class="formula" id="cf5"></td><td class="formula" id="cf6"></td><td class="formula" id="cf7"></td><td class="formula" id="cf8"></td><td class="formula" id="cf9"></td><td class="formula" id="cf10"></td></tr>
            <tr><th style="text-align:left">TAXABLE INCOME</th><td class="formula" id="taxable1">441723</td><td class="formula" id="taxable2">530931</td><td class="formula" id="taxable3"></td><td class="formula" id="taxable4"></td><td class="formula" id="taxable5"></td><td class="formula" id="taxable6"></td><td class="formula" id="taxable7"></td><td class="formula" id="taxable8"></td><td class="formula" id="taxable9"></td><td class="formula" id="taxable10"></td></tr>
            <tr><th style="text-align:left">Tax Liability (Savings)</th><td class="formula" id="taxliab1">154603</td><td class="formula" id="taxliab2">185826</td><td class="formula" id="taxliab3"></td><td class="formula" id="taxliab4"></td><td class="formula" id="taxliab5"></td><td class="formula" id="taxliab6"></td><td class="formula" id="taxliab7"></td><td class="formula" id="taxliab8"></td><td class="formula" id="taxliab9"></td><td class="formula" id="taxliab10"></td></tr>
            <tr><th style="text-align:left">Net Cash Flow (for IRR)</th><td class="formula" id="ncf1">974677</td><td class="formula" id="ncf2">1063885</td><td class="formula" id="ncf3"></td><td class="formula" id="ncf4"></td><td class="formula" id="ncf5"></td><td class="formula" id="ncf6"></td><td class="formula" id="ncf7"></td><td class="formula" id="ncf8"></td><td class="formula" id="ncf9"></td><td class="formula" id="ncf10"></td></tr>
          </tbody>
        </table>

        <div class="kpis">
          <div class="kpi"><h3>Purchase Price</h3><p id="k_purchase">$20,000,000</p></div>
          <div class="kpi"><h3>Initial Equity</h3><p id="k_equity">$8,700,000</p></div>
          <div class="kpi"><h3>Project IRR</h3><p id="k_irr">15.2%</p></div>
          <div class="kpi"><h3>Equity Multiple</h3><p id="k_em">3.15x</p></div>
          <div class="kpi"><h3>Avg Cash-on-Cash</h3><p id="k_coc">7.5%</p></div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <canvas id="chartNOI" style="flex:1;max-height:180px"></canvas>
          <canvas id="chartCF" style="flex:1;max-height:180px"></canvas>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
// Core math + helper functions
function toNum(v){return typeof v==='number'?v: (v===''?0:parseFloat(String(v).toString().replace(/[,\$]/g,''))||0)}
function fmt(n){return (Math.round(n)).toLocaleString()}
function pmty(rate, nper, pv){ // monthly PMT positive outflow
  if(rate<=0) return -(pv)/nper;
  const r = rate/12;
  return -(pv*r*Math.pow(1+r,nper))/(Math.pow(1+r,nper)-1);
}
function irr(cashflows, guess=0.12){
  let x0 = guess; let eps = 1e-6; let iter=0; while(iter<200){
    let f=0, df=0; for(let t=0;t<cashflows.length;t++){f += cashflows[t]/Math.pow(1+x0,t); df += -t*cashflows[t]/Math.pow(1+x0,t+1)}
    const x1 = x0 - f/df; if(!isFinite(x1)) break; if(Math.abs(x1-x0)<eps) return x1; x0=x1; iter++; }
  return NaN;
}

// DOM selectors
const elems = {
  totalUnits: document.getElementById('totalUnits'),
  purchasePrice: document.getElementById('purchasePrice'),
  ltv: document.getElementById('ltv'),
  interestRate: document.getElementById('interestRate'),
  amortYears: document.getElementById('amortYears'),
  loanAmount: document.getElementById('loanAmount'),
  rentGrowth: document.getElementById('rentGrowth'),
  expenseGrowth: document.getElementById('expenseGrowth'),
  otherIncome: document.getElementById('otherIncome'),
  vacancy: document.getElementById('vacancy'),
  propTaxPct: document.getElementById('propTaxPct'),
  insPerUnit: document.getElementById('insPerUnit'),
  mgmtPct: document.getElementById('mgmtPct'),
  repairsPerUnit: document.getElementById('repairsPerUnit'),
  utilPerUnit: document.getElementById('utilPerUnit'),
  turnPerUnit: document.getElementById('turnPerUnit'),
  assetPct: document.getElementById('assetPct'),
  improvePct: document.getElementById('improvePct'),
  taxRate: document.getElementById('taxRate')
};

function gatherUnits(){
  const rows = [];
  document.querySelectorAll('#unitBody tr').forEach(r=>{
    const t = r.cells[0].textContent.trim();
    const count = toNum(r.querySelector('.u-count').value);
    const sqft = toNum(r.querySelector('.u-sqft').value);
    const cur = toNum(r.querySelector('.u-cur').value);
    const pro = toNum(r.querySelector('.u-pro').value);
    rows.push({type:t,count,sqft,cur,pro});
  });
  return rows;
}

function recalc(){
  // Inputs
  const purchase = toNum(elems.purchasePrice.value);
  const ltv = toNum(elems.ltv.value)/100;
  const loan = purchase*ltv; elems.loanAmount.value = fmt(loan);
  const amort = toNum(elems.amortYears.value);
  const interest = toNum(elems.interestRate.value)/100;
  const rentGrowth = toNum(elems.rentGrowth.value)/100;
  const expenseGrowth = toNum(elems.expenseGrowth.value)/100;
  const vacancy = toNum(elems.vacancy.value)/100;
  const otherMonthly = toNum(elems.otherIncome.value);
  const units = toNum(elems.totalUnits.value);

  // Units
  const unitRows = gatherUnits();
  let rentMonthlyTotal = 0; let sqftTotal=0; let unitTotal=0;
  unitRows.forEach(r=>{ rentMonthlyTotal += r.pro * r.count; sqftTotal += r.sqft * r.count; unitTotal += r.count; });
  document.getElementById('unitTotal').textContent = unitTotal;
  document.getElementById('sqftTotal').textContent = fmt(sqftTotal);
  document.getElementById('rentTotal').textContent = fmt(rentMonthlyTotal);

  // Year arrays
  const years = 10; const gpr = []; const oi = []; const vac = []; const egi = []; const tax = []; const noi = []; const totExp = []; const cashAfter = [];

  // Year 1 base
  const gpr1 = rentMonthlyTotal * 12;
  for(let y=0;y<years;y++){
    const growthFactor = Math.pow(1+rentGrowth,y);
    gpr[y] = gpr1 * growthFactor;
    oi[y] = otherMonthly * 12 * Math.pow(1+rentGrowth,y);
    vac[y] = - (gpr[y] + oi[y]) * vacancy;
    egi[y] = gpr[y] + oi[y] + vac[y];

    // Expenses
    const propTax = purchase * (toNum(document.getElementById('propTaxPct').value)/100) * Math.pow(1+expenseGrowth,y);
    const insurance = toNum(document.getElementById('insPerUnit').value) * units * Math.pow(1+expenseGrowth,y);
    const mgmt = egi[y] * (toNum(document.getElementById('mgmtPct').value)/100);
    const repairs = toNum(document.getElementById('repairsPerUnit').value) * units * Math.pow(1+expenseGrowth,y);
    const utilities = toNum(document.getElementById('utilPerUnit').value) * units * Math.pow(1+expenseGrowth,y);
    const asset = egi[y] * (toNum(document.getElementById('assetPct').value)/100);
    const totalExpenses = propTax + insurance + mgmt + repairs + utilities + asset;

    totExp[y] = totalExpenses;
    noi[y] = egi[y] - totalExpenses;

    // Debt service
    let debtService = 0;
    if(amort===0){ debtService = loan * interest; } else { debtService = - pmty(interest, amort*12, loan) * 12; }
    if(y >= toNum(elems.loanTerm.value)) debtService = 0; // after term assume refinance or loan ends

    const capRes = - (toNum(document.getElementById('turnPerUnit').value) * units);

    cashAfter[y] = noi[y] - debtService + capRes; // capres is already negative

    // Taxable income simplified: NOI - interest - depreciation
    // approximate mortgage interest for tax = loan * interest (first-year approx)
    const mortgageInterest = loan * interest; // simple
    const improvementPct = toNum(document.getElementById('improvePct').value)/100;
    const buildingValue = purchase * improvementPct; // approximation; user can adjust
    const depreciation = buildingValue / 27.5;
    tax[y] = noi[y] - mortgageInterest - depreciation;

  }

  // Fill pro forma table fields
  for(let y=1;y<=years;y++){
    const idx = y-1;
    document.getElementById('gpr'+y).textContent = fmt(Math.round(gpr[idx]||0));
    document.getElementById('oi'+y).textContent = fmt(Math.round(oi[idx]||0));
    document.getElementById('vac'+y).textContent = fmt(Math.round(vac[idx]||0));
    document.getElementById('egi'+y).textContent = fmt(Math.round(egi[idx]||0));
    document.getElementById('tax'+y).textContent = fmt(Math.round(propTax||0));
    document.getElementById('ins'+y).textContent = fmt(Math.round(insurance||0));
    document.getElementById('mgmt'+y).textContent = fmt(Math.round(mgmt||0));
    document.getElementById('rep'+y).textContent = fmt(Math.round(repairs||0));
    document.getElementById('util'+y).textContent = fmt(Math.round(utilities||0));
    document.getElementById('asset'+y).textContent = fmt(Math.round(asset||0));
    document.getElementById('totexp'+y).textContent = fmt(Math.round(totExp[idx]||0));
    document.getElementById('noi'+y).textContent = fmt(Math.round(noi[idx]||0));
    document.getElementById('debt'+y).textContent = fmt(Math.round(- (amort===0 ? loan*interest : -pmty(interest,amort*12,loan)*12) ));
    document.getElementById('capres'+y).textContent = fmt(Math.round(capRes||0));
    document.getElementById('cf'+y).textContent = fmt(Math.round(cashAfter[idx]||0));
    document.getElementById('taxable'+y).textContent = fmt(Math.round(tax[idx]||0));
    document.getElementById('taxliab'+y).textContent = fmt(Math.round((tax[idx]||0) * (toNum(document.getElementById('taxRate').value)/100)));
    document.getElementById('ncf'+y).textContent = fmt(Math.round(cashAfter[idx]||0));
  }

  // IRR and returns
  const initialEquity = purchase - loan; // simple
  const cashFlows = [-initialEquity].concat(cashAfter.map((v,i)=> Math.round(v))); // Yr1..Yr10
  // add sale in year10: estimate exit price = NOI_year11 / capRate(assume 4.5% default)
  const capRate = 0.045; const noiYear10 = noi[9]||0; const noiYear11 = noiYear10 * 1.03; const exitPrice = noiYear11 / capRate;
  const sellingCosts = exitPrice * 0.02; const loanPayoff = loan; const netProceeds = exitPrice - sellingCosts - loanPayoff;
  cashFlows[cashFlows.length-1] += Math.round(netProceeds);

  const irrVal = irr(cashFlows);
  const em = (cashAfter.reduce((a,b)=>a+b,0) + netProceeds)/initialEquity;
  const avgCoc = ((cashAfter.reduce((a,b)=>a+b,0)/10) / initialEquity) * 100;

  document.getElementById('k_purchase').textContent = '$'+fmt(purchase);
  document.getElementById('k_equity').textContent = '$'+fmt(initialEquity);
  document.getElementById('k_irr').textContent = isNaN(irrVal)?'—': ( (irrVal*100).toFixed(1)+'%' );
  document.getElementById('k_em').textContent = em.toFixed(2)+'x';
  document.getElementById('k_coc').textContent = avgCoc.toFixed(1)+'%';

  // Charts
  updateCharts(noi, cashAfter);
}

// Charts setup
let chartNOI=null, chartCF=null;
function setupCharts(){
  const ctx1 = document.getElementById('chartNOI');
  const ctx2 = document.getElementById('chartCF');
  chartNOI = new Chart(ctx1, {type:'bar',data:{labels:[1,2,3,4,5,6,7,8,9,10],datasets:[{label:'NOI',data:[],yAxisID:'y'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
  chartCF = new Chart(ctx2, {type:'line',data:{labels:[1,2,3,4,5,6,7,8,9,10],datasets:[{label:'Cumulative CF',data:[],fill:false}]},options:{responsive:true,plugins:{legend:{display:false}}}});
}
function updateCharts(noiArr, cfArr){ if(!chartNOI) return; chartNOI.data.datasets[0].data = noiArr.map(v=>Math.round(v)); chartNOI.update(); const cum = []; let s=0; for(let i=0;i<cfArr.length;i++){ s+=cfArr[i]; cum.push(Math.round(s)); } chartCF.data.datasets[0].data = cum; chartCF.update(); }

// Export CSV (pro forma simplified)
function exportCSV(){
  const rows = [];
  const header = ['Line Item'];
  for(let y=1;y<=10;y++) header.push('Year '+y);
  rows.push(header.join(','));
  const tb = document.getElementById('proTable');
  for(let r=0;r<tb.tBodies[0].rows.length;r++){
    const row = tb.tBodies[0].rows[r];
    const cols = [];
    cols.push(row.cells[0].textContent.trim().replace(/,/g,''));
    for(let c=1;c<row.cells.length;c++){ cols.push(row.cells[c].textContent.trim().replace(/,/g,'')); }
    rows.push(cols.join(','));
  }
  const csv = rows.join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='proforma.csv'; a.click(); URL.revokeObjectURL(url);
}

// Init
document.getElementById('recalcBtn').addEventListener('click',recalc);
document.getElementById('exportBtn').addEventListener('click',exportCSV);
document.getElementById('resetBtn').addEventListener('click',()=>location.reload());
setupCharts(); recalc();
</script>
</body>
</html>
